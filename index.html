<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Music Theory Toolkit — Flats + Glow</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet"/>
  <style>
    :root{
      --bg-1:#1e1e2f; --bg-2:#2e2e3f; --glass:rgba(255,255,255,0.05);
      --accent:#6a5acd; --muted:rgba(255,255,255,0.12);
      --card-radius:14px;
      --panel-height:480px; /* unified height so tabs don't jump */
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; font-family:Roboto,system-ui,-apple-system,Segoe UI,Arial;
      background:linear-gradient(135deg,var(--bg-1),var(--bg-2)); color:#fff;
      display:flex; align-items:center; justify-content:center; padding:28px;
      font-size:clamp(14px,2vw,16px);
    }

    .app{width:100%; max-width:980px}
    header{text-align:center;margin-bottom:18px}
    h1{margin:6px 0 6px;font-weight:700;font-size:1.6rem}
    .tabs{display:inline-flex; gap:6px; background:var(--glass); padding:8px; border-radius:999px}
    .tab{border:0;background:transparent;color:#ddd;padding:8px 14px;border-radius:999px;cursor:pointer;font-weight:500}
    .tab.active{background:linear-gradient(180deg,rgba(255,255,255,0.06),rgba(255,255,255,0.02)); color:#fff; box-shadow:0 8px 22px rgba(0,0,0,0.45)}
    .main{background:linear-gradient(180deg,rgba(255,255,255,0.03),rgba(255,255,255,0.01)); border-radius:var(--card-radius); padding:18px; box-shadow:0 12px 40px rgba(0,0,0,0.55); backdrop-filter:blur(10px)}

    .panel-wrap{position:relative; height:var(--panel-height); overflow:hidden}
    /* Panels are stacked and perfectly overlap; fade by opacity/visibility */
    .panel{position:absolute; inset:0; padding:12px 8px; display:grid; grid-template-columns:1fr 320px; gap:16px;
           opacity:0; visibility:hidden; transition:opacity .36s ease, visibility .36s; }
    .panel.active{opacity:1; visibility:visible}
    @media (max-width:880px){ .panel{grid-template-columns:1fr; } .right-pane{order:-1} }

    .controls{background:rgba(255,255,255,0.02); padding:14px; border-radius:12px; display:flex; flex-direction:column; gap:10px}
    label{font-weight:600; color:#e8e8ff; margin-bottom:6px; display:block}
    .button-group{display:flex; flex-wrap:wrap; gap:8px}
    .button-group button{background:rgba(255,255,255,0.06);border:0;padding:8px 10px;border-radius:8px;color:#fff;cursor:pointer;font-weight:500}
    .button-group button.active{background:var(--accent); font-weight:700}
    input[type="text"]{width:100%; background:rgba(255,255,255,0.04); border:0; padding:10px; border-radius:8px; color:#fff; font-weight:600}

    .right-pane{background:rgba(0,0,0,0.18); padding:14px; border-radius:12px; display:flex; flex-direction:column; gap:12px; align-items:center}
    .output-row{display:flex; gap:8px; width:100%; align-items:center}
    .copy-btn{background:var(--muted); border:0; padding:8px 10px; border-radius:8px; cursor:pointer}

    /* keyboard: flats-only labels, multi-color glow, strong visual */
    .keyboard { display:flex; gap:6px; flex-wrap:wrap; justify-content:center; width:100%; }
    .key {
      --glow: rgba(106,90,205,0.55);
      padding:10px 12px;
      border-radius:8px;
      background:#2f2f37;
      min-width:52px;
      text-align:center;
      font-weight:800;
      color:#fff;
      transform-origin:center;
      transition: background-color .45s cubic-bezier(.2,.9,.2,1), box-shadow .55s ease, transform .22s ease, opacity .45s ease;
      box-shadow: 0 2px 6px rgba(0,0,0,0.5);
      opacity:0.98;
    }
    .key.on {
      background: linear-gradient(135deg, rgba(255,255,255,0.06), var(--glow));
      box-shadow: 0 6px 22px rgba(0,0,0,0.45), 0 0 40px var(--glow), 0 0 120px color-mix(in srgb, var(--glow) 50%, transparent), 0 0 200px color-mix(in srgb, var(--glow) 20%, transparent);
      transform: translateY(-6px) scale(1.03);
      opacity:1;
    }

    /* softer small text */
    .muted{color:#cfcfe6;font-size:0.92rem}
    footer{margin-top:12px;color:#cfcfe6;font-size:0.9rem;text-align:center}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="muted">Music Theory Toolkit</div>
      <h1>Scale · Chord · Transposer</h1>
      <div style="display:flex;justify-content:center;margin-top:12px">
        <div class="tabs" role="tablist" aria-label="Tools">
          <button class="tab active" data-tab="scale">Scale Explorer</button>
          <button class="tab" data-tab="chord">Chord Explorer</button>
          <button class="tab" data-tab="transposer">Instrument Transposer</button>
        </div>
      </div>
    </header>

    <main class="main">
      <div class="panel-wrap">

        <!-- SCALE -->
        <section id="scale" class="panel active" aria-hidden="false">
          <div class="controls">
            <div>
              <label>Root Note</label>
              <div id="scaleNoteGroup" class="button-group">
                <button>C</button><button>Db</button><button>D</button><button>Eb</button>
                <button>E</button><button>F</button><button>Gb</button><button>G</button>
                <button>Ab</button><button>A</button><button>Bb</button><button>B</button>
              </div>
            </div>

            <div>
              <label>Scale Type</label>
              <div id="scaleTypeGroup" class="button-group">
                <button data-intervals="2,2,1,2,2,2,1">Major</button>
                <button data-intervals="2,1,2,2,1,2,2">Natural Minor</button>
                <button data-intervals="2,1,2,2,2,1,2">Harmonic Minor</button>
                <button data-intervals="2,1,2,1,2,1,2">Dorian</button>
                <button data-intervals="1,2,2,1,2,2,2">Phrygian</button>
                <button data-intervals="2,2,2,1,2,2,1">Lydian</button>
                <button data-intervals="2,2,1,2,2,1,2">Mixolydian</button>
              </div>
            </div>

            <div>
              <label>Custom Intervals</label>
              <input id="customScaleIntervals" placeholder="e.g. 2,2,1,2,2,2,1" type="text" />
              <div class="muted" style="margin-top:6px">Comma-separated semitone steps</div>
            </div>

            <div style="margin-top:auto">
              <label>Scale Output</label>
              <div class="output-row">
                <input id="scaleOutput" readonly type="text" />
                <button id="copyScaleBtn" class="copy-btn">Copy</button>
              </div>
            </div>
          </div>

          <aside class="right-pane">
            <div style="width:100%">
              <div class="muted">Notes in scale</div>
              <input id="scaleNotesCompact" readonly type="text" />
            </div>
            <div style="width:100%">
              <div class="muted">Keyboard View (flats only)</div>
              <div id="scalePiano" class="keyboard"></div>
            </div>
          </aside>
        </section>

        <!-- CHORD -->
        <section id="chord" class="panel" aria-hidden="true">
          <div class="controls">
            <div>
              <label>Root Note</label>
              <div id="chordNoteGroup" class="button-group">
                <button>C</button><button>Db</button><button>D</button><button>Eb</button>
                <button>E</button><button>F</button><button>Gb</button><button>G</button>
                <button>Ab</button><button>A</button><button>Bb</button><button>B</button>
              </div>
            </div>

            <div>
              <label>Chord Type</label>
              <div id="chordTypeGroup" class="button-group">
                <button data-symbol="maj" data-intervals="4,3">Major</button>
                <button data-symbol="m" data-intervals="3,4">Minor</button>
                <button data-symbol="maj7" data-intervals="4,3,3">Maj7</button>
                <button data-symbol="m7" data-intervals="3,4,3">m7</button>
                <button data-symbol="7" data-intervals="4,3,4">7</button>
                <button data-symbol="aug" data-intervals="4,4">Aug</button>
                <button data-symbol="dim" data-intervals="3,3">Dim</button>
              </div>
            </div>

            <div>
              <label>Or type a chord symbol</label>
              <input id="chordInput" placeholder="e.g. Cmaj7, Abm, G7" type="text" />
              <div class="muted" style="margin-top:6px">Root can be C, Db, D, etc.</div>
            </div>

            <div style="margin-top:auto">
              <label>Chord Output</label>
              <div class="output-row">
                <input id="chordOutput" readonly type="text" />
                <button id="copyChordBtn" class="copy-btn">Copy</button>
              </div>
            </div>
          </div>

          <aside class="right-pane">
            <div style="width:100%">
              <div class="muted">Symbol</div>
              <input id="chordSymbolOutput" readonly type="text" />
            </div>
            <div style="width:100%">
              <div class="muted">Keyboard View (flats only)</div>
              <div id="chordPiano" class="keyboard"></div>
            </div>
          </aside>
        </section>

        <!-- TRANSPOSER -->
        <section id="transposer" class="panel" aria-hidden="true">
          <div class="controls">
            <div>
              <label>Input Note</label>
              <div id="transNoteGroup" class="button-group">
                <button>C</button><button>Db</button><button>D</button><button>Eb</button>
                <button>E</button><button>F</button><button>Gb</button><button>G</button>
                <button>Ab</button><button>A</button><button>Bb</button><button>B</button>
              </div>
            </div>

            <div>
              <label>From Instrument</label>
              <div id="fromGroup" class="button-group">
                <button data-val="C">C</button><button data-val="Bb">Bb</button><button data-val="Eb">Eb</button>
                <button data-val="F">F</button><button data-val="Db">Db</button><button data-val="G">G</button><button data-val="A">A</button>
              </div>
            </div>

            <div>
              <label>To Instrument</label>
              <div id="toGroup" class="button-group">
                <button data-val="C">C</button><button data-val="Bb">Bb</button><button data-val="Eb">Eb</button>
                <button data-val="F">F</button><button data-val="Db">Db</button><button data-val="G">G</button><button data-val="A">A</button>
              </div>
            </div>

            <div style="margin-top:auto">
              <label>Result</label>
              <div class="output-row">
                <input id="transposedOutput" readonly type="text" />
                <button id="copyTransBtn" class="copy-btn">Copy</button>
              </div>
              <div style="margin-top:8px">
                <div class="muted">Semitone Difference</div>
                <input id="semitoneDiff" readonly type="text" />
              </div>
            </div>
          </div>

          <aside class="right-pane">
            <div style="width:100%">
              <div class="muted">Enharmonic</div>
              <input id="transEnharmonic" readonly type="text" />
            </div>
            <div style="width:100%">
              <div class="muted">Keyboard View (flats only)</div>
              <div id="transPiano" class="keyboard"></div>
            </div>
          </aside>
        </section>

      </div>
    </main>
  </div>

  <script>
  (function(){ 'use strict';
    // Flats-only display array (labels)
    const NOTES_FLAT = ['C','Db','D','Eb','E','F','Gb','G','Ab','A','Bb','B'];

    /* Helper: toggle groups */
    function setupToggleGroup(id, onSelect){
      const group = document.getElementById(id);
      if (!group) return;
      const buttons = Array.from(group.querySelectorAll('button'));
      buttons.forEach(btn => btn.addEventListener('click', () => {
        buttons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        onSelect(btn);
      }));
      if (!buttons.some(b => b.classList.contains('active'))) buttons[0]?.classList.add('active');
    }

    /* Keyboard renderer:
       - renders flats-only labels
       - assigns per-key color via inline style --glow
       - updates .on class for active notes; transitions handle fade-in/out */
    function renderKeyboard(containerId, activeNotes = []){
      const container = document.getElementById(containerId);
      if (!container) return;

      // Build active set as indices for robust matching
      const activeIdx = new Set();
      activeNotes.forEach(n => {
        if (!n) return;
        // normalize input: accept sharps or flats by converting to index
        const index = noteToIndex(n);
        if (index !== -1) activeIdx.add(index);
      });

      // If no keys yet, create them
      if (!container.children.length) {
        NOTES_FLAT.forEach((label, idx) => {
          const key = document.createElement('div');
          key.className = 'key';
          key.dataset.idx = idx;
          key.textContent = label;

          // pick a hue per key for multi-color glow (spaced around color wheel)
          const hue = Math.round((idx * 360 / 12) + 12); // slight offset
          const glowColor = `hsla(${hue},85%,60%,0.85)`;
          key.style.setProperty('--glow', glowColor);

          container.appendChild(key);
        });
      }

      // Update classes on existing keys for smooth transitions
      Array.from(container.children).forEach(key => {
        const idx = parseInt(key.dataset.idx);
        if (activeIdx.has(idx)) {
          key.classList.add('on');
        } else {
          key.classList.remove('on');
        }
      });
    }

    // Convert note name (sharp or flat or natural) to index 0-11.
    function noteToIndex(note){
      if (!note) return -1;
      const n = String(note).trim();
      // accept both "C#", "Db", "C", etc.
      // map via both flats array and sharp equivalents
      const flats = NOTES_FLAT;
      const sharps = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];

      let idx = flats.indexOf(n);
      if (idx !== -1) return idx;
      idx = sharps.indexOf(n);
      if (idx !== -1) return idx;
      // try common normalization (e.g., lower-case b)
      const alt = n.replace('b','♭'); // harmless attempt
      idx = flats.indexOf(alt);
      return idx;
    }

    // Parse comma-separated intervals safely
    function parseIntervals(str){
      if (!str) return null;
      const arr = str.split(',').map(s => Number(s.trim())).filter(n => !Number.isNaN(n));
      return arr.length ? arr : null;
    }

    // ---------- SCALE ----------
    // ---------- SCALE ----------
function initScale() {
  let root = 'C';
  let intervals = [2,2,1,2,2,2,1];

  setupToggleGroup('scaleNoteGroup', btn => {
    root = btn.textContent.trim();
    generate();
  });

  setupToggleGroup('scaleTypeGroup', btn => {
    intervals = btn.dataset.intervals.split(',').map(Number);
    document.getElementById('customScaleIntervals').value = ''; // clear custom when switching preset
    generate();
  });

  // listen to manual interval input
  const customInput = document.getElementById('customScaleIntervals');
  customInput.addEventListener('input', () => {
    const parsed = parseIntervals(customInput.value);
    if (parsed && parsed.length) {
      intervals = parsed;
      // visually deselect scale type buttons
      document.querySelectorAll('#scaleTypeGroup button')
        .forEach(b => b.classList.remove('active'));
      generate();
    }
  });

  document.getElementById('copyScaleBtn').addEventListener('click', () => {
    navigator.clipboard.writeText(document.getElementById('scaleOutput').value || '');
    flash(document.getElementById('copyScaleBtn'));
  });

  function generate() {
    const rootIdx = noteToIndex(root);
    if (rootIdx < 0) return;
    const scale = [NOTES_FLAT[rootIdx]];
    let idx = rootIdx;
    intervals.forEach(i => {
      idx = (idx + i) % 12;
      scale.push(NOTES_FLAT[idx]);
    });
    document.getElementById('scaleOutput').value = scale.join(' - ');
    document.getElementById('scaleNotesCompact').value = scale.join(', ');
    renderKeyboard('scalePiano', scale);
  }

  // initialize defaults
  document.querySelectorAll('#scaleNoteGroup button')[0].classList.add('active');
  document.querySelectorAll('#scaleTypeGroup button')[0].classList.add('active');
  generate();
}


    // ---------- CHORD ----------
    function initChord(){
      const chordMap = { 'maj':[4,3],'m':[3,4],'maj7':[4,3,3],'m7':[3,4,3],'7':[4,3,4],'aug':[4,4],'dim':[3,3] };
      let root = 'C', intervals = chordMap['maj'], sym = 'maj';

      setupToggleGroup('chordNoteGroup', btn => { root = btn.textContent.trim(); generate(); });
      setupToggleGroup('chordTypeGroup', btn => { intervals = btn.dataset.intervals.split(',').map(Number); sym = btn.dataset.symbol; document.getElementById('chordInput').value=''; generate(); });

      document.getElementById('chordInput').addEventListener('input', (e) => {
        const val = e.target.value.trim();
        if (!val) return;
        parseSymbol(val);
      });

      document.getElementById('copyChordBtn').addEventListener('click', () => {
        navigator.clipboard.writeText(document.getElementById('chordOutput').value || '');
        flash(document.getElementById('copyChordBtn'));
      });

      function normalizeNoteInput(s){
        if (!s) return s;
        const up = s[0].toUpperCase() + (s[1] ? s.slice(1) : '');
        const idxFlat = NOTES_FLAT.indexOf(up);
        if (idxFlat !== -1) return NOTES_FLAT[idxFlat];
        // support sharps input by mapping to same index but returning flat label
        const sharps = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
        const idxSharp = sharps.indexOf(up);
        if (idxSharp !== -1) return NOTES_FLAT[idxSharp];
        return up;
      }

      function parseSymbol(sym){
        const m = sym.match(/^([A-G](?:#|b)?)(.*)$/i);
        if (!m) return;
        const rootInput = normalizeNoteInput(m[1]);
        let t = m[2] || 'maj';
        if (t === 'M') t = 'maj';
        if (t === 'min') t = 'm';
        if (!chordMap[t]) t = 'maj';
        const idx = noteToIndex(rootInput);
        if (idx === -1) return;
        root = NOTES_FLAT[idx]; intervals = chordMap[t]; sym = t;
        // update button states
        document.querySelectorAll('#chordNoteGroup button').forEach(b => b.classList.toggle('active', b.textContent === root));
        document.querySelectorAll('#chordTypeGroup button').forEach(b => b.classList.toggle('active', b.dataset.symbol === sym));
        generate();
      }

      function generate(){
        const idxRoot = noteToIndex(root);
        if (idxRoot < 0) return;
        const chord = [NOTES_FLAT[idxRoot]];
        let idx = idxRoot;
        intervals.forEach(i => { idx = (idx + i) % 12; chord.push(NOTES_FLAT[idx]); });
        document.getElementById('chordOutput').value = chord.join(' - ');
        document.getElementById('chordSymbolOutput').value = chord[0] + sym;
        renderKeyboard('chordPiano', chord);
      }

      window.generateChord = generate;
      // defaults
      document.querySelectorAll('#chordNoteGroup button')[0].classList.add('active');
      document.querySelectorAll('#chordTypeGroup button')[0].classList.add('active');
      generate();
    }

    // ---------- TRANSPOSER ----------
    function initTransposer(){
      const map = { 'C':0,'Bb':2,'Eb':-3,'F':7,'Db':1,'G':-5,'A':-9 };
      let note='C', from='C', to='C';

      setupToggleGroup('transNoteGroup', btn => { note = btn.textContent.trim(); transpose(); });
      setupToggleGroup('fromGroup', btn => { from = btn.dataset.val; transpose(); });
      setupToggleGroup('toGroup', btn => { to = btn.dataset.val; transpose(); });

      document.getElementById('copyTransBtn').addEventListener('click', () => {
        navigator.clipboard.writeText(document.getElementById('transposedOutput').value || '');
        flash(document.getElementById('copyTransBtn'));
      });

      function enh(i){ return NOTES_FLAT[i % 12]; }

      function transpose(){
        const idx = noteToIndex(note);
        if (idx < 0) return;
        const d = (map[to]||0) - (map[from]||0);
        const tIdx = (idx + d + 12) % 12;
        document.getElementById('transposedOutput').value = enh(tIdx);
        document.getElementById('semitoneDiff').value = (d >= 0 ? '+'+d : String(d));
        document.getElementById('transEnharmonic').value = NOTES_FLAT[tIdx] + ' / ' + enh(tIdx);
        renderKeyboard('transPiano', [NOTES_FLAT[tIdx]]);
      }

      window.transpose = transpose;
      // defaults
      document.querySelectorAll('#transNoteGroup button')[0].classList.add('active');
      document.querySelectorAll('#fromGroup button')[0].classList.add('active');
      document.querySelectorAll('#toGroup button')[0].classList.add('active');
      transpose();
    }

    // ---------- Tabs: unified fade ----------
    function initTabs(){
      const tabButtons = Array.from(document.querySelectorAll('.tab'));
      const panels = { scale: document.getElementById('scale'), chord: document.getElementById('chord'), transposer: document.getElementById('transposer') };
      tabButtons.forEach(tb => tb.addEventListener('click', () => {
        if (tb.classList.contains('active')) return;
        document.querySelector('.tab.active').classList.remove('active');
        tb.classList.add('active');
        Object.values(panels).forEach(p => { p.classList.remove('active'); p.setAttribute('aria-hidden','true'); });
        const key = tb.dataset.tab;
        panels[key].classList.add('active'); panels[key].setAttribute('aria-hidden','false');
        // refresh visuals
        if (key === 'scale' && window.generateScale) window.generateScale();
        if (key === 'chord' && window.generateChord) window.generateChord();
        if (key === 'transposer' && window.transpose) window.transpose();
      }));
    }

    // ---------- helpers ----------
    function flash(el){
      if (!el) return;
      const txt = el.textContent;
      el.textContent = 'Copied';
      setTimeout(()=> el.textContent = txt, 900);
    }

    // Boot
    document.addEventListener('DOMContentLoaded', () => {
      try{
        initScale(); initChord(); initTransposer(); initTabs();
        // initial render of all keyboards so they share identical DOM heights
        window.generateScale && window.generateScale();
        window.generateChord && window.generateChord();
        window.transpose && window.transpose();
      }catch(e){ console.error('Init failed', e); }
    });
  })();
  </script>
</body>
</html>
